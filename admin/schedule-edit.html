<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>スケジュール管理 | ふじみDXラボFC</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/admin.css">
</head>
<body class="admin-body">
  <header class="admin-header">
    <h1>ふじみDXラボFC 管理画面</h1>
    <div class="admin-header-right">
      <a href="../index.html" target="_blank">サイトを表示 ↗</a>
      <a href="#" id="logout-btn">ログアウト</a>
    </div>
  </header>

  <nav class="admin-sidebar">
    <a href="index.html"><span class="admin-sidebar-icon">&#128202;</span>ダッシュボード</a>
    <a href="news-edit.html"><span class="admin-sidebar-icon">&#128240;</span>お知らせ管理</a>
    <a href="schedule-edit.html" class="active"><span class="admin-sidebar-icon">&#128197;</span>スケジュール管理</a>
  </nav>

  <main class="admin-main">
    <div id="list-view">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="font-size:20px;color:#1B3A6B;">スケジュール管理</h2>
        <button class="admin-btn admin-btn-primary" onclick="showEditor()">+ 新規作成</button>
      </div>
      <div class="admin-card">
        <table class="admin-table">
          <thead><tr><th>曜日</th><th>時間</th><th>場所</th><th>対象</th><th>備考</th><th>ステータス</th><th></th></tr></thead>
          <tbody id="schedule-table"></tbody>
        </table>
      </div>
    </div>

    <div id="edit-view" style="display:none;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
        <button class="admin-btn admin-btn-secondary" onclick="showList()">&larr; 戻る</button>
        <h2 style="font-size:20px;color:#1B3A6B;" id="form-title">新規作成</h2>
      </div>
      <div class="admin-card">
        <div class="admin-form">
          <input type="hidden" id="edit-id">
          <label>曜日</label>
          <select id="edit-day">
            <option value="月曜日">月曜日</option>
            <option value="火曜日">火曜日</option>
            <option value="水曜日">水曜日</option>
            <option value="木曜日">木曜日</option>
            <option value="金曜日">金曜日</option>
            <option value="土曜日">土曜日</option>
            <option value="日曜日">日曜日</option>
          </select>
          <label>時間</label>
          <input type="text" id="edit-time" placeholder="例: 16:30〜18:00">
          <label>場所</label>
          <input type="text" id="edit-location" placeholder="例: ○○小学校グラウンド">
          <label>対象</label>
          <input type="text" id="edit-target" placeholder="例: 1〜3年生">
          <label>備考</label>
          <input type="text" id="edit-note" placeholder="例: 雨天時は体育館">
          <label>ステータス</label>
          <select id="edit-status">
            <option value="published">公開</option>
            <option value="draft">下書き</option>
          </select>
          <div class="admin-form-actions">
            <button class="admin-btn admin-btn-primary" onclick="saveItem()">保存する</button>
            <button class="admin-btn admin-btn-danger" id="delete-btn" onclick="deleteItem()" style="display:none;">削除</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="admin-toast" id="toast"></div>

  <script src="../js/schedule-store.js"></script>
  <script src="../js/auth.js"></script>
  <script>
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    function renderList() {
      const schedules = ScheduleStore.getAll();
      document.getElementById('schedule-table').innerHTML = schedules.map(s => {
        const st = s.status === 'published' ? '<span class="status-badge status-published">公開中</span>' : '<span class="status-badge status-draft">下書き</span>';
        return `<tr>
          <td>${s.day}</td><td>${s.time}</td><td>${s.location}</td><td>${s.target}</td><td>${s.note || '—'}</td><td>${st}</td>
          <td><a href="#" onclick="editItem('${s.id}');return false;" style="color:#1B3A6B;font-size:13px;font-weight:600;">編集</a></td>
        </tr>`;
      }).join('');
      if (schedules.length === 0) {
        document.getElementById('schedule-table').innerHTML = '<tr><td colspan="7" style="color:#999;text-align:center;padding:24px;">スケジュールがありません</td></tr>';
      }
    }

    function showList() {
      document.getElementById('list-view').style.display = '';
      document.getElementById('edit-view').style.display = 'none';
      renderList();
    }

    function showEditor(id) {
      document.getElementById('list-view').style.display = 'none';
      document.getElementById('edit-view').style.display = '';
      if (id) {
        const item = ScheduleStore.getById(id);
        if (!item) return showList();
        document.getElementById('edit-id').value = item.id;
        document.getElementById('edit-day').value = item.day;
        document.getElementById('edit-time').value = item.time;
        document.getElementById('edit-location').value = item.location;
        document.getElementById('edit-target').value = item.target;
        document.getElementById('edit-note').value = item.note || '';
        document.getElementById('edit-status').value = item.status;
        document.getElementById('form-title').textContent = '編集';
        document.getElementById('delete-btn').style.display = '';
      } else {
        document.getElementById('edit-id').value = '';
        document.getElementById('edit-day').value = '月曜日';
        document.getElementById('edit-time').value = '';
        document.getElementById('edit-location').value = '';
        document.getElementById('edit-target').value = '';
        document.getElementById('edit-note').value = '';
        document.getElementById('edit-status').value = 'published';
        document.getElementById('form-title').textContent = '新規作成';
        document.getElementById('delete-btn').style.display = 'none';
      }
    }

    function editItem(id) { showEditor(id); }

    function saveItem() {
      const id = document.getElementById('edit-id').value;
      const day = document.getElementById('edit-day').value;
      const time = document.getElementById('edit-time').value.trim();
      if (!time) { alert('時間を入力してください'); return; }
      ScheduleStore.save({
        id: id || undefined,
        day,
        time,
        location: document.getElementById('edit-location').value.trim(),
        target: document.getElementById('edit-target').value.trim(),
        note: document.getElementById('edit-note').value.trim(),
        status: document.getElementById('edit-status').value,
      });
      showToast('保存しました');
      showList();
    }

    function deleteItem() {
      const id = document.getElementById('edit-id').value;
      if (!id) return;
      if (!confirm('本当に削除しますか？')) return;
      ScheduleStore.delete(id);
      showToast('削除しました');
      showList();
    }

    window.onAdminAuth = function () {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (id) { showEditor(id); } else { renderList(); }
    };

    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      sessionStorage.removeItem('admin_auth_hash');
      location.reload();
    });
  </script>
</body>
</html>
